doc <<- doc %>%
body_add_par("Model Calibration: LOO-PIT QQ-Plot", style = "heading 2") %>%
body_add_img(src = content$qq_path, width = 6, height = 4) %>%
body_add_par("Figure Note: This plot assesses calibration. If the points follow the diagonal line, the model's uncertainty and probability of extremes are correctly estimated.", style = "Image Caption")
}
# C. Comparison Plot (Robustness)
if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
doc <<- doc %>%
body_add_par("Sensitivity Analysis (Threshold Comparison)", style = "heading 2") %>%
body_add_img(src = content$comp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: Comparison of effect sizes across 90th, 95th, and 99th percentiles. Consistency across thresholds demonstrates result robustness.", style = "Image Caption")
}
doc <<- doc %>% body_add_break()
})
# ----- Bayesian Results Table (Includes Fixed Effects & Hyperparameters) -----
make_bayesian_table <- function(model_data, title, subtitle = "Main Model (95%)") {
# Extract the correct dataframe from the list
if(is.list(model_data) && "full_table" %in% names(model_data)) {
tab_data <- model_data$full_table
} else {
# Fallback for raw brms objects
tab_data <- broom.mixed::tidy(model_data, effects = c("fixed", "ran_pars"), conf.int = TRUE)
}
tab <- tab_data %>%
# Clean up hyperparameter names (sd__Intercept -> sd(Intercept))
mutate(term = gsub("__", "(", term),
term = ifelse(grepl("\\(", term), paste0(term, ")"), term)) %>%
mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
select(term, estimate, std.error, conf.low, conf.high) %>%
rename(
Parameter = term,
`Posterior Mean` = estimate,
`Est. Error` = std.error,
`95% Lower CI` = conf.low,
`95% Upper CI` = conf.high
)
ft <- flextable::flextable(tab) %>%
flextable::theme_vanilla() %>%
flextable::set_caption(caption = paste(title, "-", subtitle)) %>%
# Highlight Random Effect SDs for visual hierarchy
flextable::bg(i = ~ grepl("sd\\(", Parameter), bg = "gray97") %>%
flextable::italic(i = ~ grepl("sd\\(", Parameter)) %>%
flextable::autofit()
return(ft)
}
# --- Build the master list for the Word Doc ---
# Note: 'main' is now the output from our new process_model_group
# --- Build the master list for the Word Doc ---
full_supplement_list <- list(
"Daytime Maximum Temperature (Total Period)" = list(
results   = day_total_results,
pp_path   = here("data", "figures", "pp_check_day_total.png"),
qq_path   = here("data", "figures", "pp_qq_day_total.png"),
comp_path = here("data", "figures", "comparison_day_total.png")
),
"Nighttime Minimum Temperature (Total Period)" = list(
results   = night_total_results,
pp_path   = here("data", "figures", "pp_check_night_total.png"),
qq_path   = here("data", "figures", "pp_qq_night_total.png"),
comp_path = here("data", "figures", "comparison_night_total.png")
),
"Daytime Maximum Temperature (Daily Interactions)" = list(
results   = day_date_results,
pp_path   = here("data", "figures", "pp_check_day_date.png"),
qq_path   = here("data", "figures", "pp_qq_day_date.png"),
comp_path = here("data", "figures", "comparison_day_date.png")
),
"Nighttime Minimum Temperature (Daily Interactions)" = list(
results   = night_date_results,
pp_path   = here("data", "figures", "pp_check_night_date.png"),
qq_path   = here("data", "figures", "pp_qq_night_date.png"),
comp_path = here("data", "figures", "comparison_night_date.png")
) # No comma here because it is the last item in the master list
)
# --- Generate the Document ---
doc <- read_docx()
iwalk(full_supplement_list, function(content, title) {
doc <<- doc %>%
body_add_par(title, style = "heading 1") %>%
body_add_par("Main Bayesian Model Summary (Fixed & Random Effects)", style = "heading 2") %>%
# FIX: Pass 'content$results' (the list), NOT 'content$results$full_table'
body_add_flextable(make_bayesian_table(content$results, title))
# A. Standard PP-Check
if(!is.null(content$pp_path) && file.exists(content$pp_path)) {
doc <<- doc %>%
body_add_par("Posterior Predictive Check: Distribution", style = "heading 2") %>%
body_add_img(src = content$pp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: The dark line (y) is observed data; light lines (y_rep) are simulations. This shows how well the model captures the overall shape of the temperature distribution.", style = "Image Caption")
}
# B. LOO-PIT QQ-Plot (Calibration Check)
if(!is.null(content$qq_path) && file.exists(content$qq_path)) {
doc <<- doc %>%
body_add_par("Model Calibration: LOO-PIT QQ-Plot", style = "heading 2") %>%
body_add_img(src = content$qq_path, width = 6, height = 4) %>%
body_add_par("Figure Note: This plot assesses calibration. If the points follow the diagonal line, the model's uncertainty and probability of extremes are correctly estimated.", style = "Image Caption")
}
# C. Comparison Plot (Robustness)
if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
doc <<- doc %>%
body_add_par("Sensitivity Analysis (Threshold Comparison)", style = "heading 2") %>%
body_add_img(src = content$comp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: Comparison of effect sizes across 90th, 95th, and 99th percentiles. Consistency across thresholds demonstrates result robustness.", style = "Image Caption")
}
doc <<- doc %>% body_add_break()
})
print(doc, target = here("Manuscript", "Full_Automated_Supplement.docx"))
# Helper function to generate and save a labeled pp_check
save_labeled_pp <- function(model, title, filename) {
p <- pp_check(model, ndraws = 100) +
labs(
title = paste("PP-Check:", title),
subtitle = "Observed (y) vs. Simulated (y_rep)",
x = "Temperature (째C)",
y = "Probability Density"
) +
theme_bw() +
theme(axis.title = element_text(face = "bold"), plot.title = element_text(hjust = 0.5))
ggsave(here("data", "figures", filename), p, width = 6, height = 4, dpi = 300)
}
# USE THIS VERSION to compare 90th, 95th, 99th on one plot
save_robustness_comp <- function(model_group_results, title, filename) {
# Define our desired orders
day_order <- c("Base (95th)", "max_T2_90", "max_T2_99", "max_T2")
night_order <- c("Base (05th)", "min_T2_10", "min_T2_01", "min_T2")
# Apply the order based on what labels are present in the data
plot_data <- model_group_results %>%
mutate(model_label = factor(model_label,
levels = if(any(grepl("95|90", model_label))) day_order else night_order))
p <- ggplot(plot_data, aes(x = estimate, y = term, color = model_label)) +
geom_vline(xintercept = 0, color = "black", linetype = "dashed", alpha = 0.5) +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
height = 0.3,
position = position_dodge(width = 0.7)) + # Increased dodge for clarity
geom_point(position = position_dodge(width = 0.7), size = 2) +
labs(
title = paste("Sensitivity Analysis:", title),
subtitle = "Comparing Thresholds (Robustness Check)",
x = "Effect Size (Temperature Difference 째C)",
y = "Parameter",
color = "Threshold"
) +
theme_bw() +
scale_color_brewer(palette = "Set1") +
theme(legend.position = "bottom", axis.title = element_text(face = "bold"))
ggsave(here("data", "figures", filename), p, width = 8, height = 6, dpi = 300)
}
# --- Execute Plot Generation ---
# --- EXECUTE PLOT GENERATION ---
# 1. Daytime Total Analysis
save_labeled_pp(m_day_95, "Daytime Max", "pp_check_day_total.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(day_total_results$plot_data, "Daytime Max Totals", "comparison_day_total.png")
# 2. Nighttime Total Analysis
save_labeled_pp(m_night_05, "Nighttime Min", "pp_check_night_total.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(night_total_results$plot_data, "Nighttime Min Totals", "comparison_night_total.png")
# 3. Daily Day Analysis (Interactions)
save_labeled_pp(m_day_date_95, "Daily Day (Interactions)", "pp_check_day_date.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(day_date_results$plot_data, "Daily Day Interactions", "comparison_day_date.png")
# 4. Daily Night Analysis (Interactions)
save_labeled_pp(m_night_date_05, "Daily Night (Interactions)", "pp_check_night_date.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(night_date_results$plot_data, "Daily Night Interactions", "comparison_night_date.png")
# ----- Bayesian Results Table (Includes Fixed Effects & Hyperparameters) -----
make_bayesian_table <- function(model_data, title, subtitle = "Main Model") {
if(is.list(model_data) && "full_table" %in% names(model_data)) {
tab_data <- model_data$full_table
} else {
tab_data <- broom.mixed::tidy(model_data, effects = c("fixed", "ran_pars"), conf.int = TRUE)
}
tab <- tab_data %>%
# Logic to create clean names:
# 1. If it's a random effect, use "SD (Group Name)"
# 2. If it's the residual, use "SD (Observation/Residual)"
# 3. Otherwise keep the fixed effect name
mutate(Parameter = case_when(
effect == "ran_pars" & term == "sd__(Intercept)" ~ paste0("SD (Intercept: ", group, ")"),
effect == "ran_pars" & term == "sd__Observation" ~ "SD (Residual)",
TRUE ~ term
)) %>%
mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
select(Parameter, estimate, std.error, conf.low, conf.high) %>%
rename(
`Posterior Mean` = estimate,
`Est. Error` = std.error,
`95% Lower CI` = conf.low,
`95% Upper CI` = conf.high
)
ft <- flextable::flextable(tab) %>%
flextable::theme_vanilla() %>%
flextable::set_caption(caption = paste(title, "-", subtitle)) %>%
# Visual distinction for SDs
flextable::bg(i = ~ grepl("SD \\(", Parameter), bg = "gray97") %>%
flextable::italic(i = ~ grepl("SD \\(", Parameter)) %>%
flextable::autofit()
return(ft)
}
# --- Build the master list for the Word Doc ---
# Note: 'main' is now the output from our new process_model_group
# --- Build the master list for the Word Doc ---
full_supplement_list <- list(
"Daytime Maximum Temperature (Total Period)" = list(
results   = day_total_results,
pp_path   = here("data", "figures", "pp_check_day_total.png"),
qq_path   = here("data", "figures", "pp_qq_day_total.png"),
comp_path = here("data", "figures", "comparison_day_total.png")
),
"Nighttime Minimum Temperature (Total Period)" = list(
results   = night_total_results,
pp_path   = here("data", "figures", "pp_check_night_total.png"),
qq_path   = here("data", "figures", "pp_qq_night_total.png"),
comp_path = here("data", "figures", "comparison_night_total.png")
),
"Daytime Maximum Temperature (Daily Interactions)" = list(
results   = day_date_results,
pp_path   = here("data", "figures", "pp_check_day_date.png"),
qq_path   = here("data", "figures", "pp_qq_day_date.png"),
comp_path = here("data", "figures", "comparison_day_date.png")
),
"Nighttime Minimum Temperature (Daily Interactions)" = list(
results   = night_date_results,
pp_path   = here("data", "figures", "pp_check_night_date.png"),
qq_path   = here("data", "figures", "pp_qq_night_date.png"),
comp_path = here("data", "figures", "comparison_night_date.png")
) # No comma here because it is the last item in the master list
)
# --- Generate the Document ---
doc <- read_docx()
iwalk(full_supplement_list, function(content, title) {
doc <<- doc %>%
body_add_par(title, style = "heading 1") %>%
body_add_par("Main Bayesian Model Summary (Fixed & Random Effects)", style = "heading 2") %>%
# FIX: Pass 'content$results' (the list), NOT 'content$results$full_table'
body_add_flextable(make_bayesian_table(content$results, title))
# A. Standard PP-Check
if(!is.null(content$pp_path) && file.exists(content$pp_path)) {
doc <<- doc %>%
body_add_par("Posterior Predictive Check: Distribution", style = "heading 2") %>%
body_add_img(src = content$pp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: The dark line (y) is observed data; light lines (y_rep) are simulations. This shows how well the model captures the overall shape of the temperature distribution.", style = "Image Caption")
}
# B. LOO-PIT QQ-Plot (Calibration Check)
if(!is.null(content$qq_path) && file.exists(content$qq_path)) {
doc <<- doc %>%
body_add_par("Model Calibration: LOO-PIT QQ-Plot", style = "heading 2") %>%
body_add_img(src = content$qq_path, width = 6, height = 4) %>%
body_add_par("Figure Note: This plot assesses calibration. If the points follow the diagonal line, the model's uncertainty and probability of extremes are correctly estimated.", style = "Image Caption")
}
# C. Comparison Plot (Robustness)
if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
doc <<- doc %>%
body_add_par("Sensitivity Analysis (Threshold Comparison)", style = "heading 2") %>%
body_add_img(src = content$comp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: Comparison of effect sizes across 90th, 95th, and 99th percentiles. Consistency across thresholds demonstrates result robustness.", style = "Image Caption")
}
doc <<- doc %>% body_add_break()
})
print(doc, target = here("Manuscript", "Full_Automated_Supplement.docx"))
# ----- Bayesian Results Table (Includes Fixed Effects & Hyperparameters) -----
make_bayesian_table <- function(model_data, title, subtitle = "Main Model") {
if(is.list(model_data) && "full_table" %in% names(model_data)) {
tab_data <- model_data$full_table
} else {
tab_data <- broom.mixed::tidy(model_data, effects = c("fixed", "ran_pars"), conf.int = TRUE)
}
tab <- tab_data %>%
# Logic to create clean names:
# 1. If it's a random effect, use "SD (Group Name)"
# 2. If it's the residual, use "SD (Observation/Residual)"
# 3. Otherwise keep the fixed effect name
mutate(Parameter = case_when(
effect == "ran_pars" & term == "sd__(Intercept)" ~ paste0("SD (Intercept: ", group, ")"),
effect == "ran_pars" & term == "sd__Observation" ~ "SD (Residual)",
TRUE ~ term
)) %>%
mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
select(Parameter, estimate, std.error, conf.low, conf.high) %>%
rename(
`Posterior Mean` = estimate,
`Est. Error` = std.error,
`95% Lower CI` = conf.low,
`95% Upper CI` = conf.high
)
ft <- flextable::flextable(tab) %>%
flextable::theme_vanilla() %>%
flextable::set_caption(caption = paste(title, "-", subtitle)) %>%
# Visual distinction for SDs
flextable::bg(i = ~ grepl("SD \\(", Parameter), bg = "gray97") %>%
flextable::italic(i = ~ grepl("SD \\(", Parameter)) %>%
flextable::autofit()
return(ft)
}
# --- Build the master list for the Word Doc ---
# Note: 'main' is now the output from our new process_model_group
# --- Build the master list for the Word Doc ---
full_supplement_list <- list(
"Daytime Maximum Temperature (Total Period)" = list(
results   = day_total_results,
pp_path   = here("data", "figures", "pp_check_day_total.png"),
qq_path   = here("data", "figures", "pp_qq_day_total.png"),
comp_path = here("data", "figures", "comparison_day_total.png")
),
"Nighttime Minimum Temperature (Total Period)" = list(
results   = night_total_results,
pp_path   = here("data", "figures", "pp_check_night_total.png"),
qq_path   = here("data", "figures", "pp_qq_night_total.png"),
comp_path = here("data", "figures", "comparison_night_total.png")
),
"Daytime Maximum Temperature (Daily Interactions)" = list(
results   = day_date_results,
pp_path   = here("data", "figures", "pp_check_day_date.png"),
qq_path   = here("data", "figures", "pp_qq_day_date.png"),
comp_path = here("data", "figures", "comparison_day_date.png")
),
"Nighttime Minimum Temperature (Daily Interactions)" = list(
results   = night_date_results,
pp_path   = here("data", "figures", "pp_check_night_date.png"),
qq_path   = here("data", "figures", "pp_qq_night_date.png"),
comp_path = here("data", "figures", "comparison_night_date.png")
) # No comma here because it is the last item in the master list
)
# --- Generate the Document ---
doc <- read_docx()
iwalk(full_supplement_list, function(content, title) {
doc <<- doc %>%
body_add_par(title, style = "heading 1") %>%
body_add_par("Main Bayesian Model Summary (Fixed & Random Effects)", style = "heading 2") %>%
# FIX: Pass 'content$results' (the list), NOT 'content$results$full_table'
body_add_flextable(make_bayesian_table(content$results, title))
# A. Standard PP-Check
if(!is.null(content$pp_path) && file.exists(content$pp_path)) {
doc <<- doc %>%
body_add_par("Posterior Predictive Check: Distribution", style = "heading 2") %>%
body_add_img(src = content$pp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: The dark line (y) is observed data; light lines (y_rep) are simulations. This shows how well the model captures the overall shape of the temperature distribution.", style = "Image Caption")
}
# B. LOO-PIT QQ-Plot (Calibration Check)
if(!is.null(content$qq_path) && file.exists(content$qq_path)) {
doc <<- doc %>%
body_add_par("Model Calibration: LOO-PIT QQ-Plot", style = "heading 2") %>%
body_add_img(src = content$qq_path, width = 6, height = 4) %>%
body_add_par("Figure Note: This plot assesses calibration. If the points follow the diagonal line, the model's uncertainty and probability of extremes are correctly estimated.", style = "Image Caption")
}
# C. Comparison Plot (Robustness)
if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
doc <<- doc %>%
body_add_par("Sensitivity Analysis (Threshold Comparison)", style = "heading 2") %>%
body_add_img(src = content$comp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: Comparison of effect sizes across 90th, 95th, and 99th percentiles. Consistency across thresholds demonstrates result robustness.", style = "Image Caption")
}
doc <<- doc %>% body_add_break()
})
print(doc, target = here("Manuscript", "Full_Automated_Supplement.docx"))
# Helper function to generate and save a labeled pp_check
save_labeled_pp <- function(model, title, filename) {
p <- pp_check(model, ndraws = 100) +
labs(
title = paste("PP-Check:", title),
subtitle = "Observed (y) vs. Simulated (y_rep)",
x = "Temperature (째C)",
y = "Probability Density"
) +
theme_bw() +
theme(axis.title = element_text(face = "bold"), plot.title = element_text(hjust = 0.5))
ggsave(here("data", "figures", filename), p, width = 6, height = 4, dpi = 300)
}
# USE THIS VERSION to compare 90th, 95th, 99th on one plot
save_robustness_comp <- function(model_group_results, title, filename) {
# 1. Define the specific orders you requested
day_order <- c("Base (95th)", "max_T2_90", "max_T2_99", "max_T2")
night_order <- c("Base (05th)", "min_T2_10", "min_T2_01", "min_T2")
# 2. Check if this is a Night model (contains "min")
is_night <- any(grepl("min", model_group_results$model_label))
plot_data <- model_group_results %>%
# Fix the label for Nighttime Base so it's not "95th"
mutate(model_label = if_else(is_night & model_label == "Base (95th)", "Base (05th)", model_label)) %>%
# Set the factor levels based on the model type
mutate(model_label = factor(model_label, levels = if(is_night) night_order else day_order))
p <- ggplot(plot_data, aes(x = estimate, y = term, color = model_label)) +
geom_vline(xintercept = 0, color = "black", linetype = "dashed", alpha = 0.5) +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
height = 0.4,
position = position_dodge(width = 0.6)) +
geom_point(position = position_dodge(width = 0.6), size = 2.5) +
labs(
title = title,
subtitle = "Sensitivity Analysis: Comparing Thresholds",
x = "Effect Size (Temperature Difference 째C)",
y = "Parameter",
color = "Model / Threshold"
) +
theme_bw() +
scale_color_brewer(palette = "Set1") +
theme(legend.position = "bottom",
axis.title = element_text(face = "bold"),
plot.title = element_text(size = 14))
ggsave(here("data", "figures", filename), p, width = 8, height = 6, dpi = 300)
}
# --- Execute Plot Generation ---
# --- EXECUTE PLOT GENERATION ---
# 1. Daytime Total Analysis
save_labeled_pp(m_day_95, "Daytime Max", "pp_check_day_total.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(day_total_results$plot_data, "Daytime Max Totals", "comparison_day_total.png")
# 2. Nighttime Total Analysis
save_labeled_pp(m_night_05, "Nighttime Min", "pp_check_night_total.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(night_total_results$plot_data, "Nighttime Min Totals", "comparison_night_total.png")
# 3. Daily Day Analysis (Interactions)
save_labeled_pp(m_day_date_95, "Daily Day (Interactions)", "pp_check_day_date.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(day_date_results$plot_data, "Daily Day Interactions", "comparison_day_date.png")
# 4. Daily Night Analysis (Interactions)
save_labeled_pp(m_night_date_05, "Daily Night (Interactions)", "pp_check_night_date.png")
# Fix: Access the $plot_data element from the list
save_robustness_comp(night_date_results$plot_data, "Daily Night Interactions", "comparison_night_date.png")
# ----- Bayesian Results Table (Includes Fixed Effects & Hyperparameters) -----
make_bayesian_table <- function(model_data, title, subtitle = "Main Model") {
# Handle list or model input
if(is.list(model_data) && "full_table" %in% names(model_data)) {
tab_data <- model_data$full_table
} else {
tab_data <- broom.mixed::tidy(model_data, effects = c("fixed", "ran_pars"), conf.int = TRUE)
}
tab <- tab_data %>%
# Use the 'group' column to give the SDs unique names
mutate(Parameter = case_when(
effect == "ran_pars" & term == "sd__(Intercept)" ~ paste0("SD (Intercept: ", group, ")"),
effect == "ran_pars" & term == "sd__Observation" ~ "SD (Residual)",
# Clean up Intercept for fixed effects
term == "(Intercept)" ~ "Intercept (Grand Mean)",
TRUE ~ term
)) %>%
mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
select(Parameter, estimate, std.error, conf.low, conf.high) %>%
rename(
`Posterior Mean` = estimate,
`Est. Error` = std.error,
`95% Lower CI` = conf.low,
`95% Upper CI` = conf.high
)
ft <- flextable::flextable(tab) %>%
flextable::theme_vanilla() %>%
flextable::set_caption(caption = paste(title, "-", subtitle)) %>%
# Subtle gray background for the SD rows to separate them from fixed effects
flextable::bg(i = ~ grepl("SD \\(", Parameter), bg = "gray97") %>%
flextable::italic(i = ~ grepl("SD \\(", Parameter)) %>%
flextable::autofit()
return(ft)
}
# --- Build the master list for the Word Doc ---
# Note: 'main' is now the output from our new process_model_group
# --- Build the master list for the Word Doc ---
full_supplement_list <- list(
"Daytime Maximum Temperature (Total Period)" = list(
results   = day_total_results,
pp_path   = here("data", "figures", "pp_check_day_total.png"),
qq_path   = here("data", "figures", "pp_qq_day_total.png"),
comp_path = here("data", "figures", "comparison_day_total.png")
),
"Nighttime Minimum Temperature (Total Period)" = list(
results   = night_total_results,
pp_path   = here("data", "figures", "pp_check_night_total.png"),
qq_path   = here("data", "figures", "pp_qq_night_total.png"),
comp_path = here("data", "figures", "comparison_night_total.png")
),
"Daytime Maximum Temperature (Daily Interactions)" = list(
results   = day_date_results,
pp_path   = here("data", "figures", "pp_check_day_date.png"),
qq_path   = here("data", "figures", "pp_qq_day_date.png"),
comp_path = here("data", "figures", "comparison_day_date.png")
),
"Nighttime Minimum Temperature (Daily Interactions)" = list(
results   = night_date_results,
pp_path   = here("data", "figures", "pp_check_night_date.png"),
qq_path   = here("data", "figures", "pp_qq_night_date.png"),
comp_path = here("data", "figures", "comparison_night_date.png")
) # No comma here because it is the last item in the master list
)
# --- Generate the Document ---
doc <- read_docx()
iwalk(full_supplement_list, function(content, title) {
doc <<- doc %>%
body_add_par(title, style = "heading 1") %>%
body_add_par("Main Bayesian Model Summary (Fixed & Random Effects)", style = "heading 2") %>%
# FIX: Pass 'content$results' (the list), NOT 'content$results$full_table'
body_add_flextable(make_bayesian_table(content$results, title))
# A. Standard PP-Check
if(!is.null(content$pp_path) && file.exists(content$pp_path)) {
doc <<- doc %>%
body_add_par("Posterior Predictive Check: Distribution", style = "heading 2") %>%
body_add_img(src = content$pp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: The dark line (y) is observed data; light lines (y_rep) are simulations. This shows how well the model captures the overall shape of the temperature distribution.", style = "Image Caption")
}
# B. LOO-PIT QQ-Plot (Calibration Check)
if(!is.null(content$qq_path) && file.exists(content$qq_path)) {
doc <<- doc %>%
body_add_par("Model Calibration: LOO-PIT QQ-Plot", style = "heading 2") %>%
body_add_img(src = content$qq_path, width = 6, height = 4) %>%
body_add_par("Figure Note: This plot assesses calibration. If the points follow the diagonal line, the model's uncertainty and probability of extremes are correctly estimated.", style = "Image Caption")
}
# C. Comparison Plot (Robustness)
if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
doc <<- doc %>%
body_add_par("Sensitivity Analysis (Threshold Comparison)", style = "heading 2") %>%
body_add_img(src = content$comp_path, width = 6, height = 4) %>%
body_add_par("Figure Note: Comparison of effect sizes across 90th, 95th, and 99th percentiles. Consistency across thresholds demonstrates result robustness.", style = "Image Caption")
}
doc <<- doc %>% body_add_break()
})
print(doc, target = here("Manuscript", "Full_Automated_Supplement.docx"))
