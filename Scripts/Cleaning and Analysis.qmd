---
Title: Cleaning Raw Microclimate Data
Format: html
Authors: M.R.Verschoor
Date: 2024-03-14
editor_options: 
  chunk_output_type: console
---

## Set-up

Notes: ALWAYS TRY TO RUN BEFORE CODING SO THAT PACKAGES ARE THE RIGHT VERSION AND SYNCHED WITH THE RENV ENVIRONMENT

## Loading and installing packages

```{r renv environment}

# clear everything in the R environment
rm(list = ls()) # Optional: some prefer a clean slate, others find it risky
renv::restore() # restore the library
#renv::snapshot() # snapshot the library to update renv.lock if needed

## --- Load Packages ---
library(marginaleffects)
library(data.table)
library(broom.mixed)
library(officer)
library(flextable)
library(here)
library(fasttime)
library(lubridate)
library(tidyverse)
library(MetBrewer)
library(ggh4x)
library(ggsignif)
library(ggdist)
library(patchwork)
library(brms)
library(emmeans)
library(extrafont)
library(bayesplot)
library(posterior)

## --- Directory Setup ---
# Use here() so this works regardless of where the script is launched

data_dir <- here("data")
fig_dir  <- here("data", "figures", "revisions")

if (!dir.exists(data_dir)) dir.create(data_dir)
if (!dir.exists(fig_dir))  dir.create(fig_dir, recursive = TRUE)

```

## Loading in Microclimate data

Purpose of chunk: Import and clean the microclimate data 

Notes: Here, all data .csv files are imported and stored in a single data frame. To allow identification of the individual loggers as the logger data is stored in folders corresponding to the name of the containers. The functions below will name the folder according to the file location. 

NOT NEEDED IF ALREADY MADE, CONINUE TO CHUNK BELOW (SAVES LOT OF TIME)

```{r Loading in Data Zenodo}

# These files are hosted on Zenodo at DOI: 10.5281/zenodo.16677435
options(timeout = 600) # Increase timeout to 10 minutes

# Define URLs to files on Zenodo
microclimate_url <- "https://zenodo.org/record/16677435/files/Bioclive_microclimate_shield_2024.csv?download=1"
design_url <- "https://zenodo.org/record/16677435/files/bioclive_design.csv?download=1"
weather_url <- "https://zenodo.org/records/18482920/files/TheBilt%20Weather%20station%20data%20KNMI.txt?download=1"

# Define local filenames
microclimate_file <- "data/Bioclive_microclimate_shield_2024.csv"
design_file <- "data/bioclive_design.csv"
weather_file <- "data/TheBilt Weather station data KNMI.txt"

# Create data directory if it doesn't exist
if (!dir.exists("data")) dir.create("data")

# Download microclimate data if needed
if (!file.exists(microclimate_file)) {
  message("Downloading microclimate data...")
  download.file(microclimate_url, destfile = microclimate_file, mode = "wb")
} else {
  message("Microclimate data already exists locally.")
}

# Download design data if needed
if (!file.exists(design_file)) {
  message("Downloading design file...")
  download.file(design_url, destfile = design_file, mode = "wb")
} else {
  message("Design file already exists locally.")
}

# Download weather data if needed
if (!file.exists(weather_file)) {
  message("Downloading weather file...")
  download.file(weather_url, destfile = weather_file, mode = "wb")
} else {
  message("Weather file already exists locally.")
}

# Now load the data
microclimate_shield <- readr::read_csv(microclimate_file)
bioclive_design <- readr::read_csv(design_file)
weather_data <- readr::read_csv(weather_file)

```

```{r Adding wall distance to Microclimate data}

# Loading Bioclive design
bioclive_design <- bioclive_design|>
  select(-...1) |>
  mutate(subplot = paste0(plot, subplot)) |>
  mutate(
    dist_wall = case_when(
      plot %in% 1:11 | plot %in% c(12, 22, 23, 33, 34, 44, 55, 66, 77, 45, 56, 67, 78:88) ~ 1,
      plot %in% 13:21 | plot %in% 68:76 | plot %in% c(24, 35, 46, 57, 32, 43, 54, 65) ~ 2,
      plot %in% 25:31 | plot %in% 58:64 | plot %in% c(36, 47, 53, 42) ~ 3,
      plot %in% 37:41 | plot %in% 48:52 ~ 4,
      TRUE ~ NA_real_ # If no condition matches, return NA
    )
  )

```

```{r Cleaning up the probe data}

# Cleaning up the probe data
# Lowercase plots and format the probe code

# Convert to data.table
setDT(microclimate_shield)

microclimate_shield[, subplot := tolower(subplot)]
microclimate_shield[, probe := substr(probe, 6, 13)]

# Rename columns using data.table's `setnames` for efficiency
data.table::setnames(microclimate_shield, old = names(microclimate_shield)[1:9],
         new = c("index", "DateTime", "Timezone", "T1", "T2", "T3", "Moisture", "Shake", "ErrFlag"))

microclimate_shield[, V10 := NULL]  # Remove the unnecessary column

# Convert columns T1, T2, and T3 to numeric in one go
microclimate_shield[, c("T1", "T2", "T3") := lapply(.SD, as.numeric), .SDcols = c("T1", "T2", "T3")]

# Convert DateTime to POSIXct with timezone "UTC" (adjust if different format)
microclimate_shield[, DateTime := fastPOSIXct(DateTime, tz = "UTC")]

# Add a 2-hour timezone difference
microclimate_shield[, DateTime := DateTime + hours(2)]

# Extract Date and Time from the adjusted DateTime
microclimate_shield[, Date := as.Date(DateTime)]
microclimate_shield[, Time := format(DateTime, "%H:%M:%S")]

# Extract Month and year from the adjusted DateTime and add it as a new column
microclimate_shield[, Month := format(DateTime, "%B %Y")]

# Remove the Timezone column and any extra columns
microclimate_shield[, Timezone := NULL] 

# getting the correct dates
microclimate_shield = microclimate_shield[microclimate_shield$DateTime >= "2024-08-05 00:00:00",]

# Rearrange columns
data.table::setcolorder(microclimate_shield, c("index", "DateTime", "Date", "Time", "Month", "probe", "subplot", "T1", "T2", "T3", "Moisture", "Shake", "ErrFlag"))

# Add shield presence/absence column based on `subplot`
microclimate_shield[, midshield := ifelse(
    substr(subplot, nchar(subplot), nchar(subplot)) %in% c("a", "c") | subplot == "65d", "present",
    ifelse(substr(subplot, nchar(subplot), nchar(subplot)) %in% c("b", "d") | subplot == "65c", "absent", NA_character_)
)]

```

```{r Weather station data}
## The bilt weather station data

# Loading the bilt weather station data 
weather_data <- weather_data %>%
  # Select only the variables you need
  # TX: Max Temp, TG: Mean Temp, FHX: Max Wind, Q: Radiation, SQ: Sunshine
  select(YYYYMMDD, TX, TG, FHX, Q, SQ) %>%
  rename(
    Date = YYYYMMDD,
    max_temp = TX,             # Maximum temperature (in 0.1 °C)
    mean_temp = TG,            # Mean temperature (in 0.1 °C)
    max_windspeed = FHX,       # Highest hourly average windspeed (in 0.1 m/s)
    radiation = Q,             # Global radiation (in J/cm2)
    sunshine_min = SQ          # Sunshine duration (in 0.1 hours)
  ) %>%
  mutate(
    # 1. Convert Date string to Date object
    Date = as.Date(as.character(Date), format = "%Y%m%d"),
    
    # 2. Convert Temperatures from 0.1 °C to °C
    max_temp = max_temp * 0.1,
    mean_temp = mean_temp * 0.1,
    
    # 3. Convert Max Windspeed from 0.1 m/s to m/s
    max_windspeed = max_windspeed * 0.1,
    
    # 4. Convert Sunshine from 0.1 hours to Minutes
    # Formula: (Raw Value * 0.1) * 60  => Raw Value * 6
    sunshine_min = sunshine_min * 6,
    
    # 5. Radiation (Q) remains in J/cm2
    radiation = radiation 
  )%>%
  filter(Date >= as.Date("2024-08-05") & Date <= as.Date("2024-09-04"))

```

## Processing Microclimate data and calculating the SWC

Purpose of chunk: Format Logger data and calibrate TMS raw moisture signal to volumetric Soil Water content (SWC, %).

Notes: Resulting SWC is expressed as a fraction between 0 and 1.

```{r Calculating SWC microclimate data}

# Universal TOMST calibration 
microclimate_shield <- microclimate_shield  |> 
  dplyr::mutate(SWC = round((Moisture^2 * -1.34e-08
 + Moisture * 0.0002496218 + -0.1578888
), 4))

microclimate_shield$Time <- as.POSIXct(microclimate_shield$Time, format="%H:%M:%S")

# Filtering for Peak Day (6 hours) + Quality Control
microclimate_shield_day <- microclimate_shield[
  format(Time, "%H:%M:%S") >= "11:00:00" & 
  format(Time, "%H:%M:%S") <= "17:00:00" & 
  !(subplot %in% c("63B", "58A")) &
  (SWC > 0 | is.na(SWC)) &
  # Temperature bounds (using 60 as per your last snippet)
  (T1 <= 60 & T1 >= -20 | is.na(T1)) &
  (T2 <= 60 & T2 >= -20 | is.na(T2)) &
  (T3 <= 60 & T3 >= -20 | is.na(T3))
]

# Filtering for Deep Night (23:00 - 05:00)
# Filtering for Deep Night (6 hours) + Quality Control
# Filtering for Deep Night (23:00 - 05:00)
microclimate_shield_night <- microclimate_shield[
  (format(Time, "%H:%M:%S") >= "23:00:00" | format(Time, "%H:%M:%S") <= "05:00:00") & 
  !(subplot %in% c("63B", "58A")) &
  (SWC > 0 | is.na(SWC)) &
  (T1 <= 60 & T1 >= -20 | is.na(T1)) &
  (T2 <= 60 & T2 >= -20 | is.na(T2)) &
  (T3 <= 60 & T3 >= -20 | is.na(T3))
]

```

```{r Creating the mean and max dataframe}

# Calculate the max per probe, the mean per probe for the total period

# Calculate the max per probe, the mean per probe for the total period, but group only by 'subplot' and 'Date'
microclimate_shield_total_day <- microclimate_shield_day %>%
  group_by(subplot) %>%  # Group by subplot and Date only
  dplyr::summarise(
    min_SWC = min(SWC, na.rm = TRUE),
    max_T1 = max(T1, na.rm = TRUE),
    max_T2 = max(T2, na.rm = TRUE),
    max_T3 = max(T3, na.rm = TRUE),
    min_SWC_1 = quantile(SWC, 0.01, na.rm = TRUE),
    max_T1_99 = quantile(T1, 0.99, na.rm = TRUE),
    max_T2_99 = quantile(T2, 0.99, na.rm = TRUE),
    max_T3_99 = quantile(T3, 0.99, na.rm = TRUE),
    min_SWC_5 = quantile(SWC, 0.05, na.rm = TRUE),
    max_T1_95 = quantile(T1, 0.95, na.rm = TRUE),
    max_T2_95 = quantile(T2, 0.95, na.rm = TRUE),
    max_T3_95 = quantile(T3, 0.95, na.rm = TRUE),
    min_SWC_10 = quantile(SWC, 0.10, na.rm = TRUE),
    max_T1_90 = quantile(T1, 0.90, na.rm = TRUE),
    max_T2_90 = quantile(T2, 0.90, na.rm = TRUE),
    max_T3_90 = quantile(T3, 0.90, na.rm = TRUE)
  ) %>%
  ungroup()  # Ungroup after summarisation

# Now join the original data back to keep 'probe' and 'midshield' columns
microclimate_shield_total_day <- microclimate_shield_total_day %>%
  left_join(
    microclimate_shield %>%
      select(subplot, probe, midshield) %>%
      distinct(),  # Keep distinct rows of 'probe' and 'midshield' for each subplot & Date
    by = c("subplot")
  ) |> 
  left_join(bioclive_design)

# Calculate the min per probe, the mean per probe for the total period, but group only by 'subplot' and 'Date'
microclimate_shield_total_night <- microclimate_shield_night %>%
  group_by(subplot) %>%
  dplyr::summarise(
    # absolute mins
    min_SWC = min(SWC, na.rm = TRUE),
    min_T1 = min(T1, na.rm = TRUE),
    min_T2 = min(T2, na.rm = TRUE),
    min_T3 = min(T3, na.rm = TRUE),

    # Lower quarantines (cold extremes)
    min_T1_01 = quantile(T1, 0.01, na.rm = TRUE),
    min_T2_01 = quantile(T2, 0.01, na.rm = TRUE),
    min_T3_01 = quantile(T3, 0.01, na.rm = TRUE),
    min_T1_05 = quantile(T1, 0.05, na.rm = TRUE),
    min_T2_05 = quantile(T2, 0.05, na.rm = TRUE),
    min_T3_05 = quantile(T3, 0.05, na.rm = TRUE),
    min_T1_10 = quantile(T1, 0.10, na.rm = TRUE),
    min_T2_10 = quantile(T2, 0.10, na.rm = TRUE),
    min_T3_10 = quantile(T3, 0.10, na.rm = TRUE),
    
   # SWC quantiles
    min_SWC_1 = quantile(SWC, 0.01, na.rm = TRUE),
    min_SWC_5 = quantile(SWC, 0.05, na.rm = TRUE),
    min_SWC_10 = quantile(SWC, 0.10, na.rm = TRUE)
  ) %>%
  ungroup()

# Now join the original data back to keep 'probe' and 'midshield' columns
microclimate_shield_total_night <- microclimate_shield_total_night %>%
  left_join(
    microclimate_shield %>%
      select(subplot, probe, midshield) %>%
      distinct(),  # Keep distinct rows of 'probe' and 'midshield' for each subplot & Date
    by = c("subplot")
  ) |> 
  left_join(bioclive_design)


```

```{r Creating the mean and max dataframe}

# Calculate the max per probe, the mean per probe per day

# Calculate the max per probe, the mean per probe per day, but group only by 'subplot' and 'Date'
microclimate_shield_date_day <- microclimate_shield_day %>%
  group_by(subplot, Date) %>%  # Group by subplot and Date only
   dplyr::summarise(
    min_SWC = min(SWC, na.rm = TRUE),
    max_T1 = max(T1, na.rm = TRUE),
    max_T2 = max(T2, na.rm = TRUE),
    max_T3 = max(T3, na.rm = TRUE),
    min_SWC_1 = quantile(SWC, 0.01, na.rm = TRUE),
    max_T1_99 = quantile(T1, 0.99, na.rm = TRUE),
    max_T2_99 = quantile(T2, 0.99, na.rm = TRUE),
    max_T3_99 = quantile(T3, 0.99, na.rm = TRUE),
    min_SWC_5 = quantile(SWC, 0.05, na.rm = TRUE),
    max_T1_95 = quantile(T1, 0.95, na.rm = TRUE),
    max_T2_95 = quantile(T2, 0.95, na.rm = TRUE),
    max_T3_95 = quantile(T3, 0.95, na.rm = TRUE),
    min_SWC_10 = quantile(SWC, 0.10, na.rm = TRUE),
    max_T1_90 = quantile(T1, 0.90, na.rm = TRUE),
    max_T2_90 = quantile(T2, 0.90, na.rm = TRUE),
    max_T3_90 = quantile(T3, 0.90, na.rm = TRUE)
  ) %>%
  ungroup()  # Ungroup after summarisation

# Now join the original data back to keep 'probe' and 'midshield' columns
microclimate_shield_date_day <- microclimate_shield_date_day %>%
  left_join(
    microclimate_shield %>%
      select(subplot, Date, probe, midshield) %>%
      distinct(),  # Keep distinct rows of 'probe' and 'midshield' for each subplot & Date
    by = c("subplot", "Date")
  ) |> 
  left_join(bioclive_design)

# Calculate the max per probe, the mean per probe for the total period, but group only by 'subplot' and 'Date'
microclimate_shield_date_night <- microclimate_shield_night %>%
  group_by(subplot, Date) %>%  # Group by subplot and Date only
  dplyr::summarise(
    # absolute mins
    min_SWC = min(SWC, na.rm = TRUE),
    min_T1 = min(T1, na.rm = TRUE),
    min_T2 = min(T2, na.rm = TRUE),
    min_T3 = min(T3, na.rm = TRUE),

    # Lower quarantines (cold extremes)
    min_T1_01 = quantile(T1, 0.01, na.rm = TRUE),
    min_T2_01 = quantile(T2, 0.01, na.rm = TRUE),
    min_T3_01 = quantile(T3, 0.01, na.rm = TRUE),
    min_T1_05 = quantile(T1, 0.05, na.rm = TRUE),
    min_T2_05 = quantile(T2, 0.05, na.rm = TRUE),
    min_T3_05 = quantile(T3, 0.05, na.rm = TRUE),
    min_T1_10 = quantile(T1, 0.10, na.rm = TRUE),
    min_T2_10 = quantile(T2, 0.10, na.rm = TRUE),
    min_T3_10 = quantile(T3, 0.10, na.rm = TRUE),
    
   # SWC quantiles
    min_SWC_1 = quantile(SWC, 0.01, na.rm = TRUE),
    min_SWC_5 = quantile(SWC, 0.05, na.rm = TRUE),
    min_SWC_10 = quantile(SWC, 0.10, na.rm = TRUE)
  ) %>%
  ungroup()

# Now join the original data back to keep 'probe' and 'midshield' columns
microclimate_shield_date_night <- microclimate_shield_date_night %>%
  left_join(
    microclimate_shield %>%
      select(subplot, probe, midshield) %>%
      distinct(),  # Keep distinct rows of 'probe' and 'midshield' for each subplot & Date
    by = c("subplot")
  ) |> 
  left_join(bioclive_design)

# merging with weather data

microclimate_shield_date_day <- microclimate_shield_date_day |> 
  left_join(weather_data, by="Date")

microclimate_shield_date_night <- microclimate_shield_date_night |>
  left_join(weather_data, by="Date")



```

```{r Preparing the data for analysis}

# Ensure that Date is in Date format
microclimate_shield_date_day$Date <- as.Date(microclimate_shield_date_day$Date)
microclimate_shield_date_night$Date <- as.Date(microclimate_shield_date_night$Date)

microclimate_shield_date_day$yday <- format(microclimate_shield_date_day$Date, "%j")
microclimate_shield_date_day$yday = as.numeric(microclimate_shield_date_day$yday)

microclimate_shield_date_night$yday <- format(microclimate_shield_date_night$Date, "%j")
microclimate_shield_date_night$yday = as.numeric(microclimate_shield_date_night$yday)

microclimate_shield_date_day$midshield_binomial<-as.integer(if_else(microclimate_shield_date_day$midshield=="present", 1, 0))

microclimate_shield_date_night$midshield_binomial<-as.integer(if_else(microclimate_shield_date_night$midshield=="present", 1, 0))

microclimate_shield_total_day$midshield_binomial<-as.integer(if_else(microclimate_shield_total_day$midshield=="present", 1, 0))

microclimate_shield_total_night$midshield_binomial<-as.integer(if_else(microclimate_shield_total_night$midshield=="present", 1, 0))
```

## Setting up the color palette

```{r Setting up the color palette and fonts}

# Load the color palette and ensure it has enough colors for the unique levels in `treatment`
# Define the specific colors for each treatment
palette <- met.brewer("Lakota", n = 6, type = "discrete")
# Create the expanded palette for the gradient (12 colors for 12 species)

shield_colors <- c(
  "present" = palette[5],
  "absent" = palette[3])


loadfonts(device = "all")    # Loads the fonts

```

## Analysis

```{r Helper function}

## --- Sensitivity Analysis Function ---
# This function updates a base model for different temperature thresholds,
# saves the RDS, and exports the summary text file automatically.

run_sensitivity <- function(base_model, target_vars, data, period_label, ...) {
  model_results_list <- list()
  
  for (var in target_vars) {
    message(paste0("Running sensitivity analysis for: ", var, " (", period_label, ")"))
    
    # Dynamically update the formula
    new_formula <- as.formula(paste(var, "~ ."))
    
    # Update the model with speed arguments (...)
    mod <- update(base_model, formula = new_formula, newdata = data, ...)
    
    # Save RDS
    saveRDS(mod, file = here("data", paste0("m_", var, "_", period_label, ".rds")))
    
    # Extract fixed effects for plotting later
    res <- broom.mixed::tidy(mod, effects = "fixed", conf.int = TRUE) %>%
      mutate(model_label = var)
    
    model_results_list[[var]] <- res
  }
  return(bind_rows(model_results_list))
}

## --- 2. Master Helper Function ---
process_model_group <- function(base_model, target_vars, data, label, group_name, ...) {
  
  # 1. Save PP-Check for the main model immediately
  # (Addresses reviewer request for clear axis labels)
  pp_p <- pp_check(base_model, ndraws = 100) + 
    labs(
      x = "Temperature (°C)", 
      y = "Probability Density",
      title = paste("PP-Check:", group_name),
      subtitle = "Observed data (y) vs. 100 model simulations (y_rep)"
    ) +
    theme_bw() +
    theme(axis.title = element_text(face = "bold"), plot.title = element_text(hjust = 0.5))
  
  ggsave(here("data", "figures", paste0("pp_check_", label, ".png")), pp_p, width = 7, height = 5)

  # 2. Run the sensitivity loop (passing speed arguments through ...)
  # This returns a dataframe of all thresholds combined
  all_results <- run_sensitivity(base_model, target_vars, data, label, ...)
  
  # 3. Include the base model results in the dataframe
  base_res <- broom.mixed::tidy(base_model, effects = "fixed", conf.int = TRUE) %>%
    mutate(model_label = "Base (95th)")
  
  combined_results <- bind_rows(all_results, base_res)
  
  return(combined_results)
}

# Define a weakly informative prior for all fixed effects
priors <- prior(cauchy(0, 0.5), class = "b")

```

```{r Analysis}

# --------- SECTION 1: DAY TOTAL ----------#
m_day_95 <- brm(max_T2_95 ~ midshield_binomial + (1|div) + (1|treatment) + (1|dist_wall), 
                             data = microclimate_shield_total_day, prior = priors, cores = 4, chains = 4, iter = 4000, warmup = 1000)

day_total_results <- process_model_group(
  base_model   = m_day_95,
  target_vars  = c("max_T2_90", "max_T2_99", "max_T2"),
  data         = microclimate_shield_total_day,
  label        = "day_total",
  group_name   = "Daytime Max Temp", 
  # --- ADD THESE SPEED ARGUMENTS ---
  cores = 4,           # Use 4 cores at once
  chains = 2,          # 2 chains are usually enough for sensitivity checks
  iter = 1000         # Drop iterations (500 warmup, 500 sampling)
)

summary(m_day_95)

# --------- SECTION 2: NIGHT TOTAL ----------#
m_night_05 <- brm(min_T2_05 ~ midshield_binomial + (1|div) + (1|treatment) + (1|dist_wall), 
                               data = microclimate_shield_total_night, prior = priors, cores = 4, chains = 4, iter = 4000, warmup = 1000)

night_total_results <- process_model_group(
  base_model   = m_night_05,
  target_vars  = c("min_T2_10", "min_T2_01", "min_T2"),
  data         = microclimate_shield_total_night,
  label        = "night_total",
  group_name   = "Nighttime Min Temp", 
  # --- ADD THESE SPEED ARGUMENTS ---
  cores = 4,           # Use 4 cores at once
  chains = 2,          # 2 chains are usually enough for sensitivity checks
  iter = 1000         # Drop iterations (500 warmup, 500 sampling)
)

summary(m_min_T_night)

# --------- SECTION 3: DAY DAILY (Interactions) ----------#

microclimate_shield_date_day$rad_scaled <- scale(microclimate_shield_date_day$radiation)
microclimate_shield_date_day$wind_scaled <- scale(microclimate_shield_date_day$max_windspeed)
microclimate_shield_date_day$Date <- as.factor(microclimate_shield_date_day$Date)

m_day_date_95 <- brm(max_T2_95 ~ midshield_binomial * (rad_scaled + wind_scaled) + (1|div) +  (1|treatment) + (1|dist_wall) + (1|Date), data = microclimate_shield_date_day, prior = priors, cores = 4, chains = 4, iter = 4000, warmup = 1000)

day_date_results <- process_model_group(
  base_model   = m_day_date_95,
  target_vars  = c("max_T2_90", "max_T2_99", "max_T2"),
  data         = microclimate_shield_date_day,
  label        = "day_date",
  group_name   = "Daily Day (Interactions)", 
  # --- ADD THESE SPEED ARGUMENTS ---
  cores = 4,           # Use 4 cores at once
  chains = 2,          # 2 chains are usually enough for sensitivity checks
  iter = 1000         # Drop iterations (500 warmup, 500 sampling)
)

summary(m_day_date_95)

# --------- SECTION 4: NIGHT DAILY ----------#

microclimate_shield_date_night$rad_scaled <- scale(microclimate_shield_date_night$radiation)
microclimate_shield_date_night$wind_scaled <- scale(microclimate_shield_date_night$max_windspeed)
microclimate_shield_date_night$Date <- as.factor(microclimate_shield_date_night$Date)

m_night_date_05 <- brm(min_T2_05 ~ midshield_binomial * wind_scaled + (1|div) +  (1|treatment) + (1|dist_wall) + (1|Date), data = microclimate_shield_date_night, prior = priors, cores = 4, chains = 4, iter = 4000, warmup = 1000)

night_date_results <- process_model_group(
  base_model   = m_night_date_05,
  target_vars  = c("min_T2_10", "min_T2_01", "min_T2"),
  data         = microclimate_shield_date_night,
  label        = "night_date",
  group_name   = "Daily Night (Interactions)", 
  # --- ADD THESE SPEED ARGUMENTS ---
  cores = 4,           # Use 4 cores at once
  chains = 2,          # 2 chains are usually enough for sensitivity checks
  iter = 1000         # Drop iterations (500 warmup, 500 sampling)
)

summary(m_night_date_05)

#--------- Distance wall - Spatial Heterogeneity ----------# 

m_dist = brm(max_T2_95 ~ dist_wall + (1|div), data = microclimate_shield_day, cores = 4, chains = 4, iter = 4000, warmup = 1000)

# Path for the PP-plot
spatial_pp_path <- file.path(data_path, "pp_check_spatial_dist.png")

# Save the PP-check plot
ggsave(filename = spatial_pp_path, 
       plot = pp_check(m_max_T_shield_dist), 
       width = 8, height = 6, dpi = 300)

summary(m_max_T_shield_dist)


# Save the models as .rds files
saveRDS(m_day_95, "m_day_95.rds")
saveRDS(m_night_05, "m_night_05.rds")
saveRDS(m_day_date_95, "m_day_date_95.rds")
saveRDS(m_night_date_05, "m_night_date_05.rds")


```

## Supplementary info

```{r PP_Check plots & Comparison plots}

# Helper function to generate and save a labeled pp_check
save_labeled_pp <- function(model, title, filename) {
  p <- pp_check(model, ndraws = 100) + 
    labs(
      title = paste("PP-Check:", title),
      subtitle = "Observed (y) vs. Simulated (y_rep)",
      x = "Temperature (°C)", 
      y = "Probability Density"
    ) +
    theme_bw() +
    theme(axis.title = element_text(face = "bold"), plot.title = element_text(hjust = 0.5))
  
  ggsave(here("data", "figures", filename), p, width = 6, height = 4, dpi = 300)
}

# USE THIS VERSION to compare 90th, 95th, 99th on one plot
save_robustness_comp <- function(model_group_results, title, filename) {
  p <- ggplot(model_group_results, aes(x = estimate, y = term, color = model_label)) +
    geom_vline(xintercept = 0, color = "black", linetype = "dashed", alpha = 0.5) +
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), 
                   height = 0.3, 
                   position = position_dodge(width = 0.5)) +
    geom_point(position = position_dodge(width = 0.5), size = 2) +
    labs(
      title = paste("Sensitivity Analysis:", title),
      subtitle = "Comparing Thresholds (e.g., 90th, 95th, 99th)",
      x = "Effect Size (Temperature Difference °C)",
      y = "Parameter",
      color = "Threshold"
    ) +
    theme_bw() +
    scale_color_brewer(palette = "Set1") + 
    theme(legend.position = "bottom", axis.title = element_text(face = "bold"))

  ggsave(here("data", "figures", filename), p, width = 8, height = 6, dpi = 300)
}


# --- Execute Plot Generation ---

# Section 1: Day Total
save_labeled_pp(m_max_T_day, "Daytime Max", "pp_check_day_total.png")
save_robustness_comp(day_total_results, "Daytime Max Totals", "comparison_day_total.png")

# Section 2: Night Total
save_labeled_pp(m_min_T_night, "Nighttime Min", "pp_check_night_total.png")
save_robustness_comp(night_total_results, "Nighttime Min Totals", "comparison_night_total.png")

# Section 3: Day Daily
save_labeled_pp(m_day_date_95, "Daily Day", "pp_check_day_date.png")
save_robustness_comp(day_date_results, "Daily Day Interactions", "comparison_day_date.png")

# Section 4: Night Daily
save_labeled_pp(m_night_date_05, "Daily Night", "pp_check_night_date.png")
save_robustness_comp(night_date_results, "Daily Night Interactions", "comparison_night_date.png")

```

```{r Supplementary info}

# --- Build the master list for the Word Doc ---
full_supplement_list <- list(
  "Daytime Maximum Temperature" = list(
    main = m_max_T_day,
    sensitivity = day_total_results,
    pp_path = here("data", "figures", "pp_check_day_total.png"),
    comp_path = here("data", "figures", "comparison_day_total.png")
  ),
  "Nighttime Minimum Temperature" = list(
    main = m_min_T_night,
    sensitivity = night_total_results,
    pp_path = here("data", "figures", "pp_check_night_total.png"),
    comp_path = here("data", "figures", "comparison_night_total.png")
  ),
  "Daily Day (With Interactions)" = list(
    main = m_day_date_95,
    sensitivity = day_date_results,
    pp_path = here("data", "figures", "pp_check_day_date.png"),
    comp_path = here("data", "figures", "comparison_day_date.png")
  ),
  "Daily Night (With Interactions)" = list(
    main = m_night_date_05,
    sensitivity = night_date_results,
    pp_path = here("data", "figures", "pp_check_night_date.png"),
    comp_path = here("data", "figures", "comparison_night_date.png")
  )
)

# --- Generate the Document (Updated Loop) ---
doc <- read_docx()

iwalk(full_supplement_list, function(content, title) {
  
  doc <<- doc %>%
    body_add_par(title, style = "heading 1") %>%
    body_add_par("Main Bayesian Model Summary", style = "heading 2") %>%
    body_add_flextable(make_bayesian_table(content$main, title))
  
  # PP-Check Figure with Detailed Axis Explanation for Reviewer
  if(!is.null(content$pp_path) && file.exists(content$pp_path)) {
    doc <<- doc %>% 
      body_add_par("Posterior Predictive Check", style = "heading 2") %>%
      body_add_img(src = content$pp_path, width = 6, height = 4) %>%
      body_add_par("Figure Note: The x-axis represents recorded temperature in degrees Celsius (°C). The y-axis represents Probability Density, reflecting the relative frequency of temperature values. The dark line (y) is the observed experimental data; light blue lines (y_rep) are model simulations.", style = "Image Caption")
  }

  # Comparison Plot (Annotated Forest Plot)
  if(!is.null(content$comp_path) && file.exists(content$comp_path)) {
    doc <<- doc %>% 
      body_add_par("Effect Size Estimates (Forest Plot)", style = "heading 2") %>%
      body_add_img(src = content$comp_path, width = 6, height = 4) %>%
      body_add_par("Figure Note: This plot compares the effect sizes across different thresholds (e.g., 90th, 95th, 99th percentiles). Consistency across colors indicates that the choice of temperature extreme does not alter the study's conclusions.", style = "Image Caption")
  }
  
  doc <<- doc %>% body_add_break()
})

print(doc, target = here("Manuscript", "Full_Automated_Supplement.docx"))
```

## Plots

```{r Plots}


# ------- Plot A: Daytime Violin Plot (no x-title) -------- # 

Plot_A_refined <- ggplot(microclimate_shield_total_day, aes(x = factor(midshield), y = max_T2_95, fill = midshield)) +
  # Use a half-violin (raincloud plot) to make it less crowded
  ggdist::stat_halfeye(adjust = .5, width = .3, .width = 0, justification = -.3, point_colour = NA) + 
  geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
  # Add a horizontal line at the Intercept from your Bayesian model
  geom_hline(yintercept = 29.35, linetype = "dashed", alpha = 0.5) + 
  labs(subtitle = "A: Daytime (11:00 - 17:00)", y = "Max temp (°C)") +
   theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(family = "Arial", size = 16),
    axis.text.y = element_text(family = "Arial", size = 16),
    axis.title.y = element_text(family = "Arial", size = 16, margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_color_manual(values = shield_colors) +
  scale_fill_manual(values = shield_colors)

Plot_A_refined

Plot_A <- ggplot(microclimate_shield_day, aes(x = factor(midshield, levels = c('present', 'absent')), y = max_T2_95, color = midshield, fill = midshield)) +
  geom_violin(position = position_dodge(width = 0.7), alpha = 0.3, width = 0.6) +
  geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5, position = position_dodge(width = 0.7), alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", size = 4, shape = 16, position = position_dodge(width = 0.7)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3, position = position_dodge(width = 0.7)) +
  labs(y = "Max temp (°C) at 1 cm (06:00 - 21:00)") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(family = "Arial", size = 16),
    axis.text.y = element_text(family = "Arial", size = 16),
    axis.title.y = element_text(family = "Arial", size = 16, margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_color_manual(values = shield_colors) +
  scale_fill_manual(values = shield_colors)

# ------- Plot B: Daytime Time Series (no x-title) -------- # 
Plot_B <- ggplot(microclimate_shield_date_day, aes(x = Date, y = max_T2, color = midshield, fill = midshield)) +
  stat_summary(fun = mean, geom = "point", size = 4, shape = 16) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3) +
  stat_summary(fun = mean, geom = "line", size = 1, alpha = 0.7, aes(group = midshield)) +
  labs(y = "Max daily temp (°C) at 1 cm (06:00 - 21:00)") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Arial", size = 16),
    axis.text.y = element_text(family = "Arial", size = 16),
    axis.title.y = element_text(family = "Arial", size = 16, margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_x_date(breaks = scales::date_breaks("3 days"),
               labels = scales::date_format("%b %d")) +
  scale_color_manual(values = shield_colors) +
  scale_fill_manual(values = shield_colors)

# ------- Plot C: Nighttime Violin Plot -------- # 
Plot_C <- ggplot(microclimate_shield_night, aes(x = factor(midshield, levels = c('present', 'absent')), y = min_T2_05, color = midshield, fill = midshield)) +
  geom_violin(position = position_dodge(width = 0.7), alpha = 0.3, width = 0.6) +
  geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5, position = position_dodge(width = 0.7), alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", size = 4, shape = 16, position = position_dodge(width = 0.7)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3, position = position_dodge(width = 0.7)) +
  labs(x = "Shield configuration", y = "Min temp (°C) at 1 cm (21:00 - 06:00)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(family = "Arial", size = 16),
    axis.title.x = element_text(family = "Arial", size = 16, margin = margin(t = 10)),
    axis.text.y = element_text(family = "Arial", size = 16),
    axis.title.y = element_text(family = "Arial", size = 16, margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_color_manual(values = shield_colors) +
  scale_fill_manual(values = shield_colors)

# ------- Plot D: Nighttime Time Series -------- # 
Plot_D <- ggplot(microclimate_shield_date_night, aes(x = Date, y = min_T2_05, color = midshield, fill = midshield)) +
  stat_summary(fun = mean, geom = "point", size = 4, shape = 16) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3) +
  stat_summary(fun = mean, geom = "line", size = 1, alpha = 0.7, aes(group = midshield)) +
  labs(x = "Date", y = "Min daily temp (°C) at 1 cm (21:00 - 06:00)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Arial", size = 16),
    axis.title.x = element_text(family = "Arial", size = 16, margin = margin(t = 10)),
    axis.text.y = element_text(family = "Arial", size = 16),
    axis.title.y = element_text(family = "Arial", size = 16, margin = margin(r = 10)),
    legend.position = "none"
  ) +
  scale_x_date(breaks = scales::date_breaks("3 days"),
               labels = scales::date_format("%b %d")) +
  scale_color_manual(values = shield_colors) +
  scale_fill_manual(values = shield_colors)

# ------- Combine and Adjust Layout -------- #
combined_plot <- (Plot_A + Plot_B) / (Plot_C + Plot_D) +
  theme(plot.tag = element_text(size = 20, face = "bold"),
        plot.tag.position = c(0, 1.1))  # More space between tag and plot

combined_plot

# Save to file
ggsave(file.path(data_path, "Plot_final.pdf"), combined_plot, width = 14, height = 12, dpi = 300, device = cairo_pdf)


```
